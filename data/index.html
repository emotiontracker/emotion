<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emotion data</title>
    <meta name="description" content="">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="cleartype" content="on">

    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/main.css">

    <style>
        h1{
            font-size:32px;
            font-weight:lighter;
            color:#5B529E;
            margin-bottom:40px;
        }

        .btn{
            padding: 7px 15px;
            margin-left:0;
        }

        .msg-error{
            padding: 8px 10px;
            border:none;
            border-radius:3px;
            display:block;
        }

        a.btn{
            display:inline-block;
            padding: 10px 50px;
        }

        .content {
            width: 230px;
            margin: 0 auto;
            text-align:left;
        }

        #expCount {
            font-size: 12px;
            font-weight:bold;
        }

        .count {
            font-weight:bold;
        }

        select.inpt{
            margin-left: 0;
        }

        .btn{
            width: 220px;
            margin-bottom: 0;
            text-align: left;
        }
    </style>
</head>
<body>


    <div class="center-text-wrapper">
        <div class="center-text">
            <div class="content">
            <h1>Emotion data</h1>
            <div style="margin-bottom:30px;">    
                <div>
                    <div style="text-align:left"><label for="expName">Choose experiment</label></div>
                    <select id="expName" class="inpt">
                        <option value="" selected disabled style="display:none">Getting list of experiments...</option>
                    </select>
                </div>
                <div>
                    <span>Date</span>
                    <span>
                    <input class="inpt" style="width:170px" type="text" id="expDate" placeholder="mm/dd/yyyy"/></span>
                </div>
                <div>
                    <span>Time</span>
                    <span>
                    <input class="inpt" style="width:170px" type="text" id="expTime" placeholder="hh:mm"/></span>
                </div>
                
                <div><button class="btn" id="countBtn">Found <span class="count">0</span> trials</button></div>
                <div><button class="btn btn-primary" id="genBtn">Generate CSV</button></div>
            </div>

            <div id="genButtons"></div>
            <span class="msg-error" style="opacity:0">Hola</span>
            </div>
        </div>
    </div>

    
<script src="../js/vendor/jquery-2.1.0.min.js"></script>
<script src="../js/plugins.js"></script>
<script type="text/javascript">

    function showError(msg){
        $('.msg-error').html(msg);
        $('.msg-error').velocity({opacity:1}, 100, function(){
            setTimeout(function(){
                $('.msg-error').velocity({opacity:0}, 1000);
            },3000);
        });        
    }

    var $date = $('#expDate'),
        $time = $('#expTime'),
        $name = $('#expName');

    function updateDateTime(){
        var now = new Date();
        $date.val((now.getMonth() + 1) + '/' + now.getDate() + '/' + now.getFullYear());
        $time.val(now.getHours() + ':' + now.getMinutes());
        setTimeout(updateDateTime, (60 - now.getSeconds()) * 1000 ); 
    }
    updateDateTime();


    function updateCount() {

        var exp = $name.val().trim();
        if(exp === '') return false;

        var date = $date.val().trim().split('/');
        if(date.length != 3) return false;
        date[0] = +date[0] - 1;

        var time = $time.val().trim().split(':');
        if(time.length != 2) return false;

        var dateObject = new Date(date[2], date[0], date[1], time[0], time[1]);

        $.ajax({
            url: 'http://54.172.59.119/expCount?e=' + exp + '&t=' + dateObject.getTime(),
            type: 'GET',
            dataType: 'json',
            timeout: 5000,
            success: function(exps) {
                $('.count').text(exps.count);
            },
            error: function(){}
        });      
    }

    $.ajax({
        url: 'http://54.172.59.119/exps',
        type: 'GET',
        dataType: 'json',
        timeout: 5000,
        success: function(exps) {
            
            for(var i=0; i<exps.length; i++){
                $name.append('<option value="' + exps[i] + '">' + exps[i] +'</option>');
            }
            $name.val('Default');
            updateCount();
        },
        error: function(){}
    });

    $name.on('change', function(e){
        updateCount();
    });

    $('#countBtn').on('click', function(e){
        updateCount();
    });

    $('#genBtn').on('click', function(e){
        e.preventDefault();

        var exp = $name.val().trim();
        if(exp === '') return false;

        var date = $date.val().trim().split('/');
        if(date.length != 3) return false;
        date[0] = +date[0] - 1;

        var time = $time.val().trim().split(':');
        if(time.length != 2) return false;

        var dt = new Date(date[2], date[0], date[1], time[0], time[1]);
        $('#genButtons').html('');
        $(this).prop('disabled', true);
        var self = this;
        $.ajax({
            url: 'http://54.172.59.119/expdata?e=' + exp + '&t=' + dt.getTime(),
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                if(data && data.error) {
                    showError(data.error);
                }
                else{
                    var a = document.createElement('a');
                    a.href = 'data:attachment/csv,' + data.data;
                    a.target = '_blank';
                    a.innerHTML = 'Download CSV';
                    a.className = 'btn btn-success';
                    a.download = '[' + exp + '].' + [dt.getFullYear(), dt.getMonth() + 1, dt.getDate(), dt.getHours(), dt.getMinutes()].join('.') + '.csv';
                    $('#genButtons').append(a);
                }
            },

            error: function(){
                showError('Unable to contact server');
            },

            complete: function(){
                $(self).prop('disabled', false);
            }
        });        
    });


</script>
</body>
</html>